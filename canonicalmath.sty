%% 
%% Canoncial Math
%% 
%% This is a wrapper package providing configured functionality of ams packages
%% for short, (german) mathematical articles, arguments or handout sheets.
%% 
%% Copyright (C) 2012 Jan-Bernhard Kordaß
%% 
%% This program is free software: you can redistribute it and/or modify
%% it under the terms of the GNU General Public License as published by
%% the Free Software Foundation, either version 3 of the License, or
%% (at your option) any later version.
%% 
%% This program is distributed in the hope that it will be useful,
%% but WITHOUT ANY WARRANTY; without even the implied warranty of
%% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%% GNU General Public License for more details.
%% 
%% You should have received a copy of the GNU General Public License
%% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%% 

\ProvidesPackage{canonicalmath}

\RequirePackage{babel}

\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsthm}

\RequirePackage{enumitem}
\RequirePackage{xifthen}

\RequirePackage{makeidx}

\RequirePackage{xspace}


\makeatletter

% Options
\newboolean{enableDeepNumbering}
\setboolean{enableDeepNumbering}{false}

\DeclareOption{deepnum}{
  \setboolean{enableDeepNumbering}{true}
}

\newboolean{enableMarginThm}
\setboolean{enableMarginThm}{false}

\DeclareOption{marginthm}{
  \setboolean{enableMarginThm}{true}
}

\ProcessOptions\relax

% call makeindex for an index register
\makeindex


% common mathematical operators and sets

\DeclareMathOperator{\grad}{grad} % Gradient
\DeclareMathOperator{\sgn}{sgn} % Signum
\DeclareMathOperator{\res}{res} % Residuum
\DeclareMathOperator{\n}{n} % Umlaufzahl
\DeclareMathOperator{\mspan}{span} % Lineare Hülle
\DeclareMathOperator{\sternf}{sternf}
\DeclareMathOperator{\offen}{offen}

\DeclareMathOperator{\Kern}{Kern}
\DeclareMathOperator{\Bild}{Bild}
\DeclareMathOperator{\rg}{rg} % rank (i)
\DeclareMathOperator{\Rang}{Rang} % rank (ii)
\DeclareMathOperator{\Charakt}{char}
\DeclareMathOperator{\Charakteristik}{char}
\DeclareMathOperator{\aff}{aff} % affine Hülle

\DeclareMathOperator{\Abb}{Abb} % maps
\DeclareMathOperator{\Hom}{Hom} % homomorphisms
\DeclareMathOperator{\Aut}{Aut} % automorphisms
\DeclareMathOperator{\Sym}{Sym} % symmetric group
\DeclareMathOperator{\End}{End} % endomorphisms

\DeclareMathOperator{\Id}{Id} % identity

\newcommand{\Zentrum}[1]{\ensuremath{\mathrm Z(#1)}} % Zentrum einer Gruppe
\DeclareMathOperator{\Stab}{Stab} % Stabilisator
\newcommand{\Ordnung}[1][]{ % Ordnung einer Gruppe
  \ifthenelse{\isempty{#1}}{
    \#
  }{
    \left|#1\right|
  }
}
\DeclareMathOperator{\Inn}{Inn} % Untergruppe der inneren Automorphismen

\renewcommand{\Re}{\ensuremath{\operatorname{Re}}}
\renewcommand{\Im}{\ensuremath{\operatorname{Im}}}
% \DeclareMathOperator{\Real}{Re} % real part
% \DeclareMathOperator{\Imag}{Im} % imaginary part

\DeclareMathOperator{\diam}{diam} % diameter
\DeclareMathOperator{\dist}{dist} % distance

\DeclareMathOperator{\supp}{supp} % support
\DeclareMathOperator{\Graph}{Graph}

\DeclareMathOperator{\Relation}{\scriptstyle\mathrm{R}} % custom Relation

\DeclareMathOperator{\ggT}{ggT} % größter gemeinsamer Teiler
\DeclareMathOperator{\kgV}{kgV} % kleinstes gemeinsames Vielfaches
\DeclareMathOperator{\inh}{inh} % Inhalt

% declaring Index for group theory
\newcommand{\Index}[2]{\ensuremath{(#1 \SlimDdot #2)}}

% canonic sets

\DeclareMathOperator{\R}{\mathbb{R}}
\DeclareMathOperator{\N}{\mathbb{N}}
\DeclareMathOperator{\Q}{\mathbb{Q}}
\DeclareMathOperator{\Z}{\mathbb{Z}}
\DeclareMathOperator{\C}{\mathbb{C}}
\DeclareMathOperator{\K}{\mathbb{K}}
\DeclareMathOperator{\F}{\mathbb{F}}
% Redeclare \P (Prim or Propability) and put the old, reversed "breakline P" in \BreakLineP
\let\BreakLineP\P
\renewcommand{\P}{\ensuremath{\mathbb{P}}}

\DeclareMathOperator{\RP}{\mathbb{RP}} % real projection plane
\DeclareMathOperator{\Tor}{\mathbb{T}} % torus

% canonic differentiation, 

\DeclareMathOperator{\T}{T} % tangent bundle
\DeclareMathOperator{\D}{D} % Jacobi matrix or derivative

\newcommand{\dop}{\mathrm{d}}	
\newcommand{\difffrac}[2][]{\dfrac{\dop #1}{\dop #2}}
\newcommand{\pdifffrac}[2][]{\dfrac{\partial #1}{\partial #2}}

% quotient space or group

\newcommand{\modulo}[1]{\ensuremath{/_{\displaystyle #1}}}

% canonic environments

\newcounter{thmglobal}
\swapnumbers
\theoremstyle{plain}


% Name language settings

\iflanguage{ngerman}{
  % theorem names, ngerman
  \newcommand{\cmLangThmSatz}{Satz\xspace}
  \newcommand{\cmLangThmLemma}{Lemma\xspace}
  \newcommand{\cmLangThmKor}{Korollar\xspace}
  \newcommand{\cmLangThmProp}{Proposition\xspace}

  \newcommand{\cmLangThmDfn}{Definition\xspace}
  \newcommand{\cmLangThmBsp}{Beispiel\xspace}

  \newcommand{\cmLangThmBem}{Bemerkung\xspace}

  % short forms, ngerman
  \newcommand{\cmLangThmShortSatz}{Satz\xspace}
  \newcommand{\cmLangThmShortLemma}{Lemma\xspace}
  \newcommand{\cmLangThmShortKor}{Kor\xspace}
  \newcommand{\cmLangThmShortProp}{Prop\xspace}

  \newcommand{\cmLangThmShortDfn}{Def\xspace}
  \newcommand{\cmLangThmShortBsp}{Bsp\xspace}

  \newcommand{\cmLangThmShortBem}{Bem\xspace}
}{
  % theorem names, english
  \newcommand{\cmLangThmSatz}{Theorem\xspace}
  \newcommand{\cmLangThmLemma}{Lemma\xspace}
  \newcommand{\cmLangThmKor}{Corollary\xspace}
  \newcommand{\cmLangThmProp}{Proposition\xspace}

  \newcommand{\cmLangThmDfn}{Definition\xspace}
  \newcommand{\cmLangThmBsp}{Example\xspace}

  \newcommand{\cmLangThmBem}{Remark\xspace}

  % short forms, ngerman
  \newcommand{\cmLangThmShortSatz}{Thm\xspace}
  \newcommand{\cmLangThmShortLemma}{Lemma\xspace}
  \newcommand{\cmLangThmShortKor}{Cor\xspace}
  \newcommand{\cmLangThmShortProp}{Prop\xspace}

  \newcommand{\cmLangThmShortDfn}{Def\xspace}
  \newcommand{\cmLangThmShortBsp}{Exp\xspace}

  \newcommand{\cmLangThmShortBem}{Rem\xspace}
}


\ifthenelse{\boolean{enableMarginThm}}{

  % use the especially for lecture scripts and summeries designed margin theorem style
  \RequirePackage{marginnote}

  \newcommand{\CmMarginThmHead}[1]{\textsf{\textbf{#1}}}
  \newcommand{\CmMarginThmNum}{\arabic{section}.\ifthenelse{\boolean{enableDeepNumbering}}{\arabic{subsection}}{}.\arabic{thmglobal}\xspace}
  \newcommand{\CmMarginThmDescription}[1][]{\ifthenelse{\isempty{#1}}{}{ \textit{#1}}}
  \newlength{\cmMarginThmSpaceBottom}
  \setlength{\cmMarginThmSpaceBottom}{0.3cm}
  \newlength{\cmMarginThmSpaceTop}
  \setlength{\cmMarginThmSpaceTop}{0.1cm}
  \newcommand{\CmMarginThmStandardLayoutBegin}[2]{
    \refstepcounter{thmglobal}
    \vspace{\cmMarginThmSpaceTop}
    \marginnote{\CmMarginThmHead{\CmMarginThmNum #2} \CmMarginThmDescription[#1]}
  }
  \newcommand{\CmMarginThmStandardLayoutEnd}{\vspace{\cmMarginThmSpaceBottom}}

  \newenvironment{satz}[1][]{
    \CmMarginThmStandardLayoutBegin{#1}{\cmLangThmShortSatz}
    \begin{itshape}
    }{\end{itshape}\CmMarginThmStandardLayoutEnd}
  \newenvironment{lemma}[1][]{
    \CmMarginThmStandardLayoutBegin{#1}{\cmLangThmShortLemma}
    \begin{itshape}
    }{\end{itshape}\CmMarginThmStandardLayoutEnd}
  \newenvironment{kor}[1][]{
    \CmMarginThmStandardLayoutBegin{#1}{\cmLangThmShortKor}
    \begin{itshape}
    }{\end{itshape}\CmMarginThmStandardLayoutEnd}
  \newenvironment{prop}[1][]{
    \CmMarginThmStandardLayoutBegin{#1}{\cmLangThmShortProp}
    \begin{itshape}
    }{\end{itshape}\CmMarginThmStandardLayoutEnd}

  \newenvironment{dfn}[1][]{
    \CmMarginThmStandardLayoutBegin{#1}{\cmLangThmShortDfn}
  }{\CmMarginThmStandardLayoutEnd}
  \newenvironment{bsp}[1][]{
    \CmMarginThmStandardLayoutBegin{#1}{\cmLangThmShortBsp}
  }{\CmMarginThmStandardLayoutEnd}

  \newenvironment{bem}[1][]{
    \CmMarginThmStandardLayoutBegin{#1}{\cmLangThmShortBem}
  }{\CmMarginThmStandardLayoutEnd}

}{% use classic amsthm theorems

  \newtheorem{satz}[thmglobal]{\cmLangThmSatz}
  \newtheorem{lemma}[thmglobal]{\cmLangThmLemma}
  \newtheorem{kor}[thmglobal]{\cmLangThmKor}
  \newtheorem{prop}[thmglobal]{\cmLangThmProp}

  \theoremstyle{definition}

  \newtheorem{dfn}[thmglobal]{\cmLangThmDfn}
  \newtheorem{bsp}[thmglobal]{\cmLangThmBsp}

  \theoremstyle{remark}

  \newtheorem{bem}[thmglobal]{\cmLangThmBem}
}

% Add unnumbered Theorems, use amsthm style in both style modes
\theoremstyle{plain}
\newtheorem*{satz*}{\cmLangThmSatz}
\newtheorem*{lemma*}{\cmLangThmLemma}
\newtheorem*{kor*}{\cmLangThmKor}
\newtheorem*{prop*}{\cmLangThmProp}

\theoremstyle{definition}
\newtheorem*{dfn*}{\cmLangThmDfn}
\newtheorem*{bsp*}{\cmLangThmBsp}

\theoremstyle{remark}
\newtheorem*{bem*}{\cmLangThmBem}


% 2-level numbering$
\numberwithin{thmglobal}{section}

% check if 3-level numbering is enabled
\ifthenelse{\boolean{enableDeepNumbering}}{
  \numberwithin{thmglobal}{subsection}
}{}


% some other customisations

% changing enumerations
\setlist[enumerate]{label=(\arabic*), itemsep=0cm, leftmargin=2cm}
\setlist[itemize]{itemsep=0cm, leftmargin=2cm}

% replace the slim emptyset symbol
\let\emptyset\varnothing

% set line distances
\linespread{1.1}

% Add a ':' for mathmode with tiny whitespaces around
\newcommand{\SlimDdot}{\ensuremath{\mathrm{:}}}


% headline and cover generation commands

% generate a simple headline
% usage: \CmHeadline[date]{title}{topic}{author}
\newcommand{\CmHeadline}[4][]{
  \begin{minipage}[t]{\textwidth}
    \huge{\textbf{#2}}\\
    \large{#3, #4}\relax
    \ifthenelse{\isempty{#1}}{}{\relax\large{, #1}}
  \end{minipage}
}

% generate a simple cover page
% usage: \CmCover[type(,skript)]{title}{subtitle}{date}
\newcommand{\CmCover}[4][]{
  \thispagestyle{empty}
  \begin{titlepage}
    \begin{center}
      \begin{minipage}[b]{0.8\textwidth}
	\vspace*{5cm}
        \ifthenelse{\isempty{#1}}{
          % Default cover arrangement
          \Huge{\textbf{#2}}\\[0.5cm]
          \huge{#3}\\[0.8cm]
          \Large{#4}
        }{
          \ifthenelse{\equal{#1}{skript}}{
            % Cover for lecture scripts
            \huge{#3}\\[0.5cm]
            \Huge{\textbf{#2}}\\[0.5cm]
            \Large{#4}
          }{}
        }
      \end{minipage}
    \end{center}
  \end{titlepage}
  \pagebreak
}


% indexing support

% Print and index given text
% usage: \CmIndex{[(optionally put another text for the index in here)]{(text to print and add to index)}
\newcommand{\CmIndex}[2][]{\ifthenelse{\isempty{#1}}{\index{#2}}{\index{#1}}#2}

% Highlight(bold) and index the given text
% usage: \CmMark[(optionally put another text for the index in here)]{(text to highlight and add to index)}
\newcommand{\CmMark}[2][]{\textbf{\CmIndex[#1]{#2}}}


% sectioning support

% Prints a description for a section in italic, bold. Most likely to use right under \section.
% usage: \CmSectionDescription{(short description of section contents)}
\newcommand{\CmSectionDescription}[1]{
  \vspace{-0.3cm}
  \hangindent=0.4cm
  \hangafter=0
  \begin{itshape}
    \textbf{#1}
  \end{itshape}
  \vspace{0.3cm}
}

% Starts a new paragraph inside of a theorem environment (as defined above)
% usage \CmSubThm[(paragraph title)]
\newenvironment{CmSubThm}[1]{
  \begin{itemize}[leftmargin=0.5cm,label=]
  \item
    \ifthenelse{\isempty{#1}}{}{
      \hspace{-0.5cm}(\textit{#1})\\[0.2cm]
    }
  }{
  \end{itemize}
}


% svg updater
% needs shell escape option

% Checks if the given image file has been modified and a custom command (if possible) via command line to generate something new.
\newcommand{\CmExecuteIfFileNewer}[3]{
  \ifnum\pdfstrcmp{\pdffilemoddate{#1}}
  {\pdffilemoddate{#2}}>0
  {\immediate\write18{#3}}\fi
}

% Tries to include an image file and checks if the given one has been modified. If so it calls inkscape (if possible) via command line to generate new pdf und pdf_tex files from the corresponding svg.
\newcommand{\CmIncludeSvg}[1]{
  \def\svg@filepath{}
  
  % check if corrosponding svg file exists
  \IfFileExists{#1.svg}
  {
    \def\svg@filepath{#1}
  }{
    % if it does not, search in the graphicspath for it
    \expandafter\@tfor\expandafter\currentsvgpath\expandafter:\expandafter=\Ginput@path\do{
      \IfFileExists{\currentsvgpath#1.svg}{
        \edef\svg@filepath{\currentsvgpath #1}
      }{}
    }
  }
  % if something was found, include the graphic, TODO: Make it work correctly
  \ifthenelse{\isundefined{\svg@filepath} \OR \isempty{\svg@filepath}}{
    \PackageError{canonicalmath}{Image file not found!}
  }{
    \PackageWarning{FilePath}{|\svg@filepath|}
    \CmExecuteIfFileNewer{\svg@filepath.svg}{\svg@filepath.pdf}{inkscape -z -D --file=\svg@filepath.svg --export-pdf=\svg@filepath.pdf --export-latex}
    \input{\svg@filepath.pdf_tex}
  }
}

% Tries to include an image file on the center of the margin at the current position.
\newcommand{\CmMarginSvg}[3][0cm]{
  \marginnote{
    \centering
    \def\svgwidth{#3}
    \CmIncludeSvg{#2}
  }[#1]
}

% Tries to include an image file centering it at the current position
\newcommand{\CmPutSvg}[3][0cm]{
  \begin{figure}[h!]
    \vspace{#1}
    \centering
    \def\svgwidth{#3}
    \CmIncludeSvg{#2}
  \end{figure}
}
\makeatother